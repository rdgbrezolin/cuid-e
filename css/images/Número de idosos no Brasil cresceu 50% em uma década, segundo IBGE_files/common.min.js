/*! zaz-ui-portal - v1.0.0 - 04/06/2018 -- 1:40pm */
zaz.use(function notificationBell(pkg){"use strict";pkg.require(["modFactory"],function(modFactory){var device=pkg.context.platform.get("type"),mediaService=pkg.context.page.get("mediaService");modFactory.create({name:"notificationBell",version:"1.0.0",state:"ok",docs:"http://github.tpn.terra.com/pages/terra/zaz-ui-portal",source:"http://github.tpn.terra.com/Terra/zaz-ui-portal",description:"modulo notification bell",tests:"",dependencies:[],setup:function(data){function setBackToTop(){var objBackTop=document.getElementById("push-notification-bell"),targetLine=200,flagVisible=!0,e=document.documentElement;if(0===e.scrollTop){var t=e.scrollTop;++e.scrollTop,e=t+1===e.scrollTop--?e:document.body}e.scrollTop>targetLine&&(objBackTop.style.display="none",flagVisible=!1),window.addEventListener("scroll",function(){setTimeout(function(){e.scrollTop>targetLine?flagVisible&&(objBackTop.style.display="none",flagVisible=!1):flagVisible||(objBackTop.style.display="",flagVisible=!0)},1e3)})}var that=this,divBell=document.createElement("div");divBell.id="push-notification-bell",divBell.style.cssText="position: fixed; z-index: 9999; cursor:pointer; bottom: 8px; right: 20px;",divBell.className="icon icon-40 icon-notification-bell animation-swing",divBell.onclick=that.click,document.body.appendChild(divBell),mediaService&&setBackToTop()},click:function(e){var containerClickName="sc-user-login";"mob"==device&&(containerClickName="sc-menu-arrow"),document.getElementById(containerClickName).click(),document.getElementById("push-notification-bell").style.display="none",e.stopPropagation(),"function"==typeof window.gaTerra&&window.gaTerra("send","event","bell","clicked",{dimension9:"terra"})},teardown:function(data){}})})}),zaz.use(function generateNotifications(pkg){"use strict";pkg.require(["modFactory"],function(modFactory){modFactory.create({name:"generateNotifications",version:"1.0.0",state:"ok",docs:"http://github.tpn.terra.com/pages/terra/zaz-ui-portal",source:"http://github.tpn.terra.com/Terra/zaz-ui-portal",description:"gerador de notificacoes do portal",tests:"",dependencies:[],setup:function(data){var PUBLIC={},PRIVATE={};return PRIVATE.renotifyAfterSeconds=2592e3,PRIVATE.signos={aquarius:"aquário",pisces:"peixes",aries:"áries",taurus:"touro",gemini:"gêmeos",cancer:"câncer",leo:"leão",virgo:"virgem",libra:"libra",scorpio:"escorpião",sagittarius:"sagitário",capricorn:"capricórnio"},PUBLIC.generate=function(userArea){pkg.require(["mod.notifications"],function(modNotification){modNotification.getAllNotifications(function getAllNotifications(notifications){var addHoroscopeNotification=function(){return new Promise(function(resolve,reject){var notifyKey="horoscope";return userArea&&userArea.notifications&&userArea.notifications[notifyKey]?resolve():void pkg.context.user.get("horoscope",function(horoscope){if(horoscope||(horoscope=pkg.context.page.get("horoscope")),horoscope){for(var groupName="web_notification_"+notifyKey+"_v1",notified=!1,i=0;i<notifications.length;i++)if(notifications[i].group===groupName){notified=!0;break}if(notified)modNotification.setUnread(notifications[i].id,PRIVATE.renotifyAfterSeconds,function(){resolve()});else{var segments="br_horoscope_"+horoscope;modNotification.add({message:{pt:"Você gostaria de receber o horóscopo de <strong>"+PRIVATE.signos[horoscope].toUpperCase()+"</strong> todas as manhãs?",es:""},complement:"",group:groupName,icon:horoscope,button:{url:"#"+notifyKey}},function(){resolve()})}}else resolve()})})},addTeamNotification=function(){return new Promise(function(resolve,reject){return userArea&&userArea.notifications&&userArea.notifications.myteammatches?resolve():void pkg.context.user.get("myTeam",function(team){if(team&&team.userTeam&&team.userTeam.teamName&&team.userTeam.teamId){for(var groupName="web_notification_team_matches_v1",notified=!1,i=0;i<notifications.length;i++)if(notifications[i].group===groupName){notified=!0;break}if(notified)modNotification.setUnread(notifications[i].id,PRIVATE.renotifyAfterSeconds,function(){resolve()});else{var segments="br_matches_"+team.userTeam.teamId;modNotification.add({message:{pt:"Clique aqui e seja notificado quando o <strong>"+team.userTeam.teamName+"</strong> estiver jogando.",es:""},complement:"",group:groupName,icon:"ball",button:{url:"#myteammatches"}},function(){resolve()})}}else resolve()})})},addTerraClubeNotification=function(){return new Promise(function(resolve,reject){var notifyKey="terraclube";return userArea&&userArea.notifications&&userArea.notifications[notifyKey]?resolve():void pkg.context.user.get("idperm",function(idperm){if(idperm){for(var groupName="web_notification_"+notifyKey+"_v1",notified=!1,i=0;i<notifications.length;i++)if(notifications[i].group===groupName){notified=!0;break}notified?resolve():modNotification.add({message:{pt:"Clique aqui e fique por dentro das novidades do <strong>Terra Clube</strong>. Ofertas fresquinhas pra você.",es:""},complement:"",group:groupName,icon:"terra-clube-orange",button:{url:"#"+notifyKey}},function(){resolve()})}else resolve()})})},addBreakingNewsNotification=function(){return new Promise(function(resolve,reject){var notifyKey="breakingnews";if(userArea&&userArea.notifications&&userArea.notifications[notifyKey])return resolve();for(var groupName="web_notification_"+notifyKey+"_v1",notified=!1,i=0;i<notifications.length;i++)if(notifications[i].group===groupName){notified=!0;break}notified?modNotification.setUnread(notifications[i].id,PRIVATE.renotifyAfterSeconds,function(){resolve()}):modNotification.add({message:{pt:"O Terra gostaria de enviar notificações das principais notícias para você.",es:""},complement:"",group:groupName,icon:"trending",button:{url:"#"+notifyKey}},function(){resolve()})})},addChannelNotification=function(){return new Promise(function(resolve,reject){var notifyKey=pkg.context.page.get("notifyKey"),notifyIcon=pkg.context.page.get("notifyIcon"),notifyText=pkg.context.page.get("notifyText");if(notifyKey&&notifyIcon&&notifyText){for(var groupName="web_notification_"+notifyKey+"_v1",notified=!1,i=0;i<notifications.length;i++)if(notifications[i].group===groupName){notified=!0;break}notified?modNotification.setUnread(notifications[i].id,PRIVATE.renotifyAfterSeconds,function(){resolve()}):modNotification.add({message:{pt:notifyText,es:""},complement:"",group:groupName,icon:notifyIcon,button:{url:"#"+notifyKey}},function(){resolve()})}else resolve()})},notifyNightMode=function(){return new Promise(function(resolve,reject){for(var notified=!1,i=0;i<notifications.length;i++)"user_config_nightmode"===notifications[i].group&&(notified=!0);notified?resolve():modNotification.add({message:{pt:"O <strong>Terra</strong> acaba de disponibilizar a função <em>modo noturno</em>, clique aqui para configurá-la.",es:""},icon:"user-area-nightmode",group:"user_config_nightmode",button:{url:"#config"}},function(){resolve()})})};notifyNightMode().then(function(){"serviceWorker"in navigator&&window.Notification&&"denied"!=window.Notification.permission&&navigator.permissions&&navigator.permissions.query&&navigator.serviceWorker.getRegistration().then(function(registration){registration&&registration.pushManager&&addBreakingNewsNotification().then(function(){addChannelNotification().then(function(){addTerraClubeNotification().then(function(){addHoroscopeNotification().then(function(){addTeamNotification().then(function(){modNotification.getAllNotifications(function(notificationsUpdated){for(var unreadWebPushNotification=!1,promptNewsUnread=!1,notificationsPrompt=["#breakingnews","#myteammatches","#horoscope","#noticias_educacao"],i=0;i<notificationsUpdated.length;i++)!notificationsUpdated[i].read&&notificationsUpdated[i].group.startsWith("web_notification")&&(unreadWebPushNotification=notificationsUpdated[i],notificationsPrompt.indexOf(unreadWebPushNotification.button.url)>=0&&(promptNewsUnread=unreadWebPushNotification));unreadWebPushNotification&&(promptNewsUnread?pkg.require("app.popupNotifications",function(PopupNotifications){var popup=new PopupNotifications(promptNewsUnread)}):pkg.require(["mod.notificationBell"],function(NotificationBell){console.log("notification bell added")}))})})})})})})})})})})},PUBLIC},teardown:function(data){}})})}),zaz.use(function modNotificationsHelper(pkg){"use strict";var modFactory=pkg.factoryManager.get("mod"),thisAddon=null,fcmConfig={apiKey:"AIzaSyDNoHkE1xCMNGYguKOLZSPvkPhnceRIfZQ",authDomain:"sacred-lane-175517.firebaseapp.com",databaseURL:"https://sacred-lane-175517.firebaseio.com",projectId:"sacred-lane-175517",storageBucket:"sacred-lane-175517.appspot.com",messagingSenderId:"1094148948752"};modFactory.create({name:"notificationsHelper",version:"1.0.0",state:"ok",dependencies:[],description:"Utilitarios para notificações.",setup:function(){console.log("modulo notificationsHelper criado"),thisAddon=this},loadFirebaseMessaging:function(){return new Promise(function(resolve,reject){pkg.require(["FireBaseCore"],function(){if(!window.firebase.apps.length)var firebase=window.firebase.initializeApp(fcmConfig);var messaging=window.firebase.messaging();resolve(messaging)})})},addNotificationListener:function(messaging){messaging.onMessage(function(payload){var notificationTitle=payload.data.title,notificationOptions={body:payload.data.body,icon:payload.data.icon,image:payload.data.image,actions:JSON.parse(payload.data.actions),data:payload.data};"function"==typeof window.gaTerra&&window.gaTerra("send","event","push_notification_show",payload.data.segment,payload.data.title+" - "+payload.data.body,{dimension9:"terra"}),navigator.serviceWorker.getRegistration("/push/fcm/").then(function(registration){registration.showNotification(notificationTitle,notificationOptions)})})},postSegments:function(action,segments,token,stalkerKeyName,provider){return new Promise(function(resolve,reject){var xhr=new XMLHttpRequest;xhr.timeout=1e4,xhr.onreadystatechange=function(){xhr.readyState==XMLHttpRequest.DONE&&(200==xhr.status?(console.log("Topic registration success.",xhr.response),resolve()):(console.log("Topic registration failed.",xhr.response,xhr.status),reject()))},xhr.open("POST","https://api.terra.com/notifications/sendNotification",!0),xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),xhr.send(encodeURI("segments="+segments+"&segments_action="+action+"&country=br&provider="+provider+"&user_token="+encodeURI(token)))})},postMigration:function(GoRoostToken,FirebaseToken){return new Promise(function(resolve,reject){var xactId=pkg.utils.getCookie("X-XAct-ID"),xhr=new XMLHttpRequest;xhr.timeout=3e4,xhr.onreadystatechange=function(){xhr.readyState==XMLHttpRequest.DONE&&(200==xhr.status?(console.log("Topic registration success.",xhr.response),resolve(xhr.response)):(console.log("Topic registration failed.",xhr.response,xhr.status),reject(xhr.status)))},xhr.open("POST","https://api.terra.com/notifications/sendNotification",!0),xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),xhr.send(encodeURI("migrate=true&goroost_token="+encodeURI(GoRoostToken)+"&fcm_token="+FirebaseToken+"&country=br&xact_id="+xactId))})},doMigration:function(userArea){return new Promise(function(resolve,reject){thisAddon.loadFirebaseMessaging().then(function(messaging){console.log("Firebase JS loaded on doMigration method."),navigator.serviceWorker.register("/push/fcm/fcm.js",{scope:"/push/fcm/"}).then(function(registration){console.log("Firebase serviceworker registered.");try{messaging.useServiceWorker(registration)}catch(e){}messaging.getToken().then(function(FirebaseToken){FirebaseToken?(console.log("Firebase Token OK",FirebaseToken),thisAddon.postMigration(userArea.GoRoostToken,FirebaseToken).then(function(response){console.log("Migration to Firebase succeeded on postMigration promise.",response),userArea.FirebaseToken=FirebaseToken,response.indexOf("breakingnews")>0&&(userArea.notifications.breakingnews=!0),response.indexOf("matches")>0&&(userArea.notifications.myteammatches=!0),response.indexOf("horoscope")>0&&(userArea.notifications.horoscope=!0),response.indexOf("terraclube")>0&&(userArea.notifications.terraclube=!0),response.indexOf("noticias_educacao")>0&&(userArea.notifications.noticias_educacao=!0),pkg.context.user.set("userArea",userArea),thisAddon.removeRoostWorker().then(function(){console.log("Roost worker removed on the end of the migration to Firebase."),resolve()})["catch"](function(){console.log("Couldnt remove Roost worker on the end of the migration to Firebase."),resolve()})})["catch"](function(response){console.log("Migration to Firebase failed on postMigration promise.",response),reject("post_segments_failed_status_"+response)})):(console.log("Firebase Couldnt get token. No Instance ID token available."),reject("couldnt_get_token_value_was_null"))})["catch"](function(err){console.log("Firebase An error occurred while retrieving token. ",err),reject("couldnt_get_token_"+err.code+"_"+err.message)})})["catch"](function(err){console.log("Firebase Unable to register ServiceWorker.",err),reject("couldnt_register_serviceworker")})})})},isFirebaseSWRegistered:function(){return new Promise(function(resolve,reject){navigator.serviceWorker.getRegistration("/push/fcm/").then(function(registration){registration&&registration.active&&registration.active.scriptURL.indexOf("fcm.js")>0?(console.log("Firebase serviceworker is registered.",registration),resolve()):reject()})})},isRoostSWRegistered:function(){return new Promise(function(resolve,reject){navigator.serviceWorker.getRegistration("/push/").then(function(registration){registration&&registration.active&&registration.active.scriptURL.indexOf("roost_worker.js")>0?(console.log("Roost serviceworker is registered.",registration),resolve()):reject()})})},removeRoostWorker:function(){return new Promise(function(resolve,reject){navigator.serviceWorker.getRegistration("/push/").then(function(registration){registration&&registration.active&&registration.active.scriptURL.indexOf("roost_worker.js")>0?(console.log("Roost serviceworker is registered. Trying to unregister",registration),registration.unregister().then(function(success){console.log("Roost service worker unregistered.",success),resolve()})):(console.log("Roost serviceworker was not found. No need to unregister it.",registration),resolve())})})},browserSupportsPush:function(){return"serviceWorker"in navigator&&"PushManager"in window&&"Notification"in window&&"fetch"in window&&ServiceWorkerRegistration.prototype.hasOwnProperty("showNotification")&&PushSubscription.prototype.hasOwnProperty("getKey")},openAuthorizationPopup:function(action,segments,stalkerKeyName){var params="width=600,height=400",urlPopup="https://www.terra.com.br/push/fcm/notifications_popup_fcm.html",w=window.open(urlPopup+"?action="+action+"&segments="+segments+"&stalkerKeyName="+stalkerKeyName,"Notification",params)},teardown:function(reason){}})}),zaz.use(function(pkg){"use strict";pkg.context.page.at("hash",function(data){data&&"#xact"==data.current&&pkg.require("app.xactDashboard")}),pkg.utils.cheats.create("xact".split(""),function(){pkg.require("app.xactDashboard")}),window.addEventListener("beforeinstallprompt",function(e){e.userChoice.then(function(choiceResult){var result;result="dismissed"==choiceResult.outcome?"cancel":"add","function"==typeof window.gaTerra&&window.gaTerra("send","event","PWA","homescreen",result,{dimension9:"terra"})})}),pkg.context.user.get("userArea",function(userArea){pkg.require(["mod.generateNotifications"],function(GenerateNotifications){GenerateNotifications.generate(userArea)}),pkg.require(["mod.notificationsHelper"],function(notificationsHelper){if("www.terra.com.br"==window.location.hostname&&notificationsHelper.browserSupportsPush()&&"granted"==window.Notification.permission){if(userArea&&userArea.FirebaseToken)console.log("Firebase token already on userArea. Lets double check for Roost serviceWorker removal..."),notificationsHelper.isRoostSWRegistered().then(function(){notificationsHelper.removeRoostWorker().then(function(){console.log("Roost worker removed during double check of Firebase migration."),"function"==typeof window.gaTerra&&window.gaTerra("send","event","info","stalker","migration_check_roost_serviceworker",{dimension9:"terra"})})["catch"]()})["catch"](function(){console.log("Roost worker not found during double check of Firebase migration.")});else{userArea||(userArea={theme:"default"}),userArea.notifications||(userArea.notifications={});var d=Math.random();1>d?(console.log("User doesnt have FirebaseToken. Starting migration..."),"function"==typeof window.gaTerra&&window.gaTerra("send","event","info","stalker","migration_started",{dimension9:"terra"}),notificationsHelper.doMigration(userArea).then(function(){console.log("User migrated to Firebase."),"function"==typeof window.gaTerra&&window.gaTerra("send","event","info","stalker","migration_success",{dimension9:"terra"})})["catch"](function(reason){console.log("Couldnt migrate user to Firebase."),"function"==typeof window.gaTerra&&window.gaTerra("send","event","info","stalker","migration_error_"+reason,{dimension9:"terra"})})):console.log("User doesnt have FirebaseToken but migration was aborted due to contest.",d)}notificationsHelper.isFirebaseSWRegistered().then(function(){notificationsHelper.loadFirebaseMessaging().then(function(messaging){console.log("Firebase Messaging loaded on ui-portal.",messaging),notificationsHelper.addNotificationListener(messaging)})})["catch"](function(){console.log("Firebase SW is not registered")})}})})});