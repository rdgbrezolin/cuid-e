/*! zaz-mod-viewable - v1.0.2 - 20/02/2017 -- 7:02pm */
zaz.use(function zazModViewable(pkg){"use strict";var console=pkg.console,require=pkg.require,define=pkg.define,modFactory=pkg.factoryManager.get("mod"),STATIC={};modFactory.create({name:"viewable",version:"1.0.0",state:"ok",docs:"http://github.tpn.terra.com/pages/terra/zaz-mod-viewable",source:"http://github.tpn.terra.com/Terra/zaz-mod-viewable",tests:"http://s1.trrsf.com/fe/zaz-mod-viewable/tests/index.htm?zaz[env]=tests",description:"DOM Element viewable API",setup:function(data){function Viewable(precision){if(PUBLIC)return PUBLIC;var PRIVATE_STATIC={},PUBLIC_STATIC={},last=[],objs=[],deleted=[],cbcount=1,viewableDebug=!1,_heightPercent=null,PRECISION=parseInt(precision)>0?precision:100;this.isVisible=function(elem,heightPercent){if(!elem||"object"!=typeof elem||1!==elem.nodeType)throw new Error("Invalid element to check visibility: "+elem+" "+Object.prototype.toString.call(elem));var elemTop=0,winHeight=window.innerHeight||document.documentElement.clientHeight,scrollTop=window.scrollY?window.scrollY:document.documentElement.scrollTop,heightData=PRIVATE_STATIC._getHeightEx(elem),objHeight=parseInt(elem.offsetHeight);return(!heightPercent||0>=heightPercent||heightPercent>1)&&(_heightPercent=.01),heightData&&(elemTop=heightData.top,"fixed"==heightData.mode&&(scrollTop=0)),elemTop>scrollTop&&scrollTop+winHeight>elemTop&&scrollTop+winHeight>elemTop+objHeight*_heightPercent?!0:elemTop+objHeight>scrollTop&&scrollTop+winHeight>elemTop+objHeight&&elemTop+objHeight-objHeight*_heightPercent>scrollTop?!0:scrollTop>=elemTop&&elemTop+objHeight>scrollTop+winHeight?!0:!1},this.resumeListener=function(callbackId){deleted[callbackId]&&delete deleted[callbackId]},this.pauseListener=function(callbackId){deleted[callbackId]||(deleted[callbackId]=!0)},this.onVisibilityChange=function(elem,heightPercent,funcView,funcHide,offsetTop,offsetBottom,callbackId,tmplist){var actlist=PRIVATE.list;if(tmplist&&(actlist=tmplist),callbackId||(callbackId=cbcount++),elem&&!elem.nodeType){if(!elem.element||!elem.onVisible&&!elem.onHidden)return console.log("[Viewable] It doesn't make any sense call this function this way.",elem),!1;heightPercent=elem.heightPercent,funcView=elem.onVisible,funcHide=elem.onHidden,offsetTop=elem.offsetTop,offsetBottom=elem.offsetBottom,elem=elem.element}if(!elem||!elem.id||!document.getElementById(elem.id))return console.log("[Viewable] You should choose an element, shouldn't you?",elem),!1;if(!funcView&&!funcHide)return console.log("[Viewable] How about passing at least one callback?"),!1;0>heightPercent&&(heightPercent=0);var d=PRIVATE_STATIC._getHeightEx(elem),t=d.top?d.top:0,h=parseInt(elem.offsetHeight),rt=t;if(!t||!h)return console.log("[Viewable] Could not get top or height"),!1;offsetTop&&offsetTop+t>0&&(rt=t+offsetTop),offsetBottom&&offsetBottom+h>0&&(h+=offsetBottom);var n=Math.floor(rt/PRECISION),a=Math.ceil((h+t)/PRECISION),s=a-n,m=s/2+n,dt=Math.floor(m-s/2*heightPercent),db=Math.ceil(m+s/2*heightPercent);if(dt>=db&&(dt-=1),viewableDebug&&console.log("[Viewable] Start: ",dt," End: ",db,"(a: ",a,"n: ",n,"s: ",s,"t: ",t,"rt: ",rt,")",elem.id,funcView,offsetTop,offsetBottom,heightPercent),"fixed"==d.mode&&(viewableDebug&&console.log("[Viewable] Element ",elem," position is absolute or fixed"),this.isVisible(elem))){var body=document.body,html=document.documentElement,height=Math.max(body.scrollHeight,body.offsetHeight,html.clientHeight,html.scrollHeight,html.offsetHeight);dt=0,db=height/PRECISION,viewableDebug&&console.log("[Viewable] Will fill the array for absolute element from ",dt," to ",db)}for(var x=dt;db>x;x++)actlist[x]||(actlist[x]={callbacks:[]}),actlist[x].callbacks.push({onVisible:funcView,onHidden:funcHide,offsetTop:offsetTop,offsetBottom:offsetBottom,callbackId:callbackId,elem:elem});return viewableDebug&&console.log("[Viewable] Element ",elem.id," added to array from position ",dt," till ",db,". Update mode? ",tmplist?"Yes":"No"),tmplist||objs.push({elem:elem,heightPercent:heightPercent,onVisible:funcView,onHidden:funcHide,offsetTop:offsetTop,offsetBottom:offsetBottom,callbackId:callbackId}),PRIVATE_STATIC._viewableCheck(this),viewableDebug&&console.log("[Viewable] Listeners array list:: ",actlist),callbackId},PRIVATE_STATIC._isVisible=function(obj){viewableDebug&&console.log("[Viewable] Showing: ",obj.elem.id,". Paused? ",deleted[obj.callbackId]?"Yes":"No",". Calling ",obj.onVisible),obj.onVisible&&!deleted[obj.callbackId]&&obj.onVisible.call(this,obj.elem,obj.callbackId)},PRIVATE_STATIC._isHidden=function(obj){viewableDebug&&console.log("[Viewable] Hidding: ",obj.elem.id,". Paused? ",deleted[obj.callbackId]?"Yes":"No",". Calling ",obj.onHidden),obj&&obj.onHidden&&!deleted[obj.callbackId]&&obj.onHidden.call(this,obj.elem,obj.callbackId)},PRIVATE_STATIC._viewableCheck=function(_this){var body=document.body,html=document.documentElement,height=Math.max(body.scrollHeight,body.offsetHeight,html.clientHeight,html.scrollHeight,html.offsetHeight);PRIVATE_STATIC.lastHeight!==height&&(PRIVATE_STATIC.lastHeight=height,PRIVATE_STATIC.updateAll(_this,"_viewableCheck"));var curr=[],windowHeight=window.innerHeight||document.documentElement.clientHeight,a=Math.floor(windowHeight/PRECISION),t=Math.floor((window.scrollY?window.scrollY:document.documentElement.scrollTop)/PRECISION);viewableDebug&&console.log("[Viewable] Scroll array window. Start: ",t," End: ",t+a);for(var x=t;t+a>x;x++)if(x>=0&&PRIVATE.list[x]&&PRIVATE.list[x].callbacks.length)for(var y=0;y<PRIVATE.list[x].callbacks.length;y++)last[PRIVATE.list[x].callbacks[y].callbackId]||(PRIVATE_STATIC._isVisible(PRIVATE.list[x].callbacks[y]),last[PRIVATE.list[x].callbacks[y].callbackId]=PRIVATE.list[x].callbacks[y]),curr[PRIVATE.list[x].callbacks[y].callbackId]=PRIVATE.list[x].callbacks[y];for(var key in last)last.hasOwnProperty(key)&&(curr[key]||(PRIVATE_STATIC._isHidden(last[key]),delete last[key]))},PRIVATE_STATIC.updateAll=function(_this,caller){viewableDebug&&console.log("[Viewable] UpdateAll called: ",caller);var _newlist=[];for(var x in objs)objs.hasOwnProperty(x)&&_this.onVisibilityChange(objs[x].elem,objs[x].heightPercent,objs[x].onVisible,objs[x].onHidden,objs[x].offsetTop,objs[x].offsetBottom,objs[x].callbackId,_newlist);PRIVATE.list=_newlist},PRIVATE_STATIC._getHeight=function(el){for(var topPos=0;null!==el;)topPos+=el.offsetTop,el=el.offsetParent;return topPos},PRIVATE_STATIC._getLeft=function(el){for(var leftPos=0;null!==el;)leftPos+=el.offsetLeft,el=el.offsetParent;return leftPos},PRIVATE_STATIC._getHeightEx=function(el){for(var mode="relative",topPos=0;el&&null!==el;)topPos+=el.offsetTop,"fixed"==el.style.position&&(mode="fixed"),el=el.offsetParent;return{mode:mode,top:topPos}},this.getHeight=function(el){return PRIVATE_STATIC._getHeight(el)},this.getLeft=function(el){return PRIVATE_STATIC._getLeft(el)},this.getHeightEx=function(el){return PRIVATE_STATIC._getHeightEx(el)},this.debug=function(){console.log("[Viewable] Debug mode on"),window.viewableDebug=this,viewableDebug=!0},this.dump=function(){console.log("[Viewable] Dump: ",PRIVATE.list)},this.updateAll=function(){PRIVATE_STATIC.updateAll(this,"external")};var _this=this,queryStrings=pkg.context.page.get("query");return queryStrings&&queryStrings["mod.viewable.debug"]&&this.debug(),PRIVATE_STATIC._viewableCheck(_this),window.addEventListener("scroll",function(){PRIVATE_STATIC._viewableCheck(_this)}),console.log("[Viewable] API started! Precision:",PRECISION),PUBLIC=this,PUBLIC}var PUBLIC,PRIVATE=[];return Viewable},teardown:function(reason){}})});