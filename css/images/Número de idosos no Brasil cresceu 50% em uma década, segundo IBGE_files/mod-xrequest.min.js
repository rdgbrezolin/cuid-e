/*! zaz-mod-xrequest - v2.0.2 - 12/09/2017 -- 1:40pm */
zaz.use(function modXrequest(pkg){"use strict";var console=pkg.console,require=pkg.require,modFactory=pkg.factoryManager.get("mod");modFactory.create({name:"xRequest",version:"2.0.1",state:"ok",docs:"http://github.tpn.terra.com/pages/terra/zaz-mod-xrequest",source:"http://github.tpn.terra.com/Terra/zaz-mod-xrequest",tests:"http://s1.trrsf.com/fe/zaz-mod-xrequest/tests/index.htm?zaz[env]=tests",dependencies:["mod.fetch","mod.promise"],description:"Request wrapper for fetch, including a JSONP implementation, with fallbacks for IE9",setup:function(data){window._jsonpCallbacks={};var STATIC_PRIVATE={proxyFrameId:"xRequest-proxy",noop:function(){},dependencies:data.dependencies,callbacks:window._jsonpCallbacks,counter:0,timeouts:{},injected:[],proxies:{}},STATIC_PUBLIC;return STATIC_PRIVATE.flashPromise=new STATIC_PRIVATE.dependencies["mod.promise"](function(resolve,reject){STATIC_PRIVATE.resolveFlashPromise=resolve}),STATIC_PRIVATE.iframePromise=new STATIC_PRIVATE.dependencies["mod.promise"](function(resolve,reject){STATIC_PRIVATE.resolveIFramePromise=resolve}),STATIC_PRIVATE.injectProxyFrame=function(basePath){if(-1===STATIC_PRIVATE.injected.indexOf("frame")){STATIC_PRIVATE.injected.push("frame");var temp=basePath.match(/https?:\/\/[a-z0-9.-]+/i);if(temp&&1===temp.length)STATIC_PRIVATE.frameOrigin=temp[0];else{var a=document.createElement("a");a.href=basePath,a.href=a.href,STATIC_PRIVATE.frameOrigin="https://"+a.hostname,console.warning("[mod.xrequest] Unable to parse origin from BasePath. Assuming HTTPS:",STATIC_PRIVATE.frameOrigin)}var f=document.createElement("iframe");f.src=basePath+"/server.html",f.style.visibility="hidden",f.style.width="1px",f.style.height="1px",f.style.position="absolute",f.id=STATIC_PRIVATE.proxyFrameId,f.addEventListener("load",function(){STATIC_PRIVATE.proxyFrame=document.getElementById(STATIC_PRIVATE.proxyFrameId),window.addEventListener("message",function(event){if(event.origin===STATIC_PRIVATE.frameOrigin){var data=JSON.parse(event.data);data.hasOwnProperty("i")&&(data.init&&data.init===!0?(STATIC_PRIVATE.resolveIFramePromise(),console.info("[mod.xrequest] Successfully injected XDomainRequest proxy")):STATIC_PRIVATE.proxies[data.i].handleResponse(data))}})}),document.getElementsByTagName("body")[0].appendChild(f)}},STATIC_PRIVATE.injectFlashObject=function(basePath){if(-1===STATIC_PRIVATE.injected.indexOf("flash")){STATIC_PRIVATE.injected.push("flash");var waitForFlash=function(){try{flensed.flXHR.module_ready(),console.info("[mod.xrequest] flXHR legacy fallback (Flash) was loaded successfully"),STATIC_PRIVATE.resolveFlashPromise()}catch(e){setTimeout(waitForFlash,250)}},s=document.createElement("script");s.src=basePath+"/flXHR.js",s.type="text/javascript",s.addEventListener("load",waitForFlash),document.getElementsByTagName("head")[0].appendChild(s)}},STATIC_PRIVATE.isCrossDomain=function(url,protocolOnly){var a=document.createElement("a");a.href=url;var loc=window.location;return protocolOnly?loc.protocol!==a.protocol:url.match(/^https?:\/\//)?(loc.port||"80")!==(a.port||"80")||loc.protocol!==a.protocol||loc.hostname!==a.hostname:!1},STATIC_PRIVATE.parseMime=function(contentType,asXHR){var temp=(contentType||"text/plain").toLowerCase().split(";")[0].split("/");return temp.length<2&&(temp=["text","plain"]),-1!==["plain","html"].indexOf(temp[1])?"text":asXHR&&"xml"===temp[1]?"document":temp[1]},STATIC_PRIVATE.parseXML=function(xmlString){try{return window.DOMParser?(new DOMParser).parseFromString(xmlString,"text/xml"):(xmlDoc=new ActiveXObject("Microsoft.XMLDOM"),xmlDoc.async=!1,xmlDoc.loadXML(xmlString),xmlDoc)}catch(e){return null}},STATIC_PRIVATE.createContext=function(options,response){return{_options:options,_response:response,_xhr:null,getXHR:function(){return this._xhr},getStatusCode:function(){return this._response?this._response.status:0},getHeaders:function(){return this._response?this._response.headers:{}},getHeader:function(name){return this._response?this._response.headers.get(name):null},getRequestURL:function(){return this._options.url},getRequestHeaders:function(){return this._options.headers?this._options.headers:{}},getParsedResponseType:function(){return this._response?STATIC_PRIVATE.parseMime(this._response.headers.get("Content-Type")||"text/html"):null}}},STATIC_PRIVATE.createMockXHR=function(options,response,text,xml,json){return{readyState:4,status:response?response.status:0,statusText:response?response.status.toString()+" "+response.statusText:"",response:json||xml||text,responseText:text||null,responseType:response&&response.headers?STATIC_PRIVATE.parseMime(response.headers.get("Content-Type"),!0):"json",responseXML:xml,timeout:options.timeout||0}},STATIC_PRIVATE.xhrProxyClass=function(){var PUB=this,PRIV={id:STATIC_PRIVATE.counter++};return PRIV.handleResponse=function(data){data.m&&PUB[data.m]&&"function"==typeof PUB[data.m]?(pkg.utils.merge(PUB,data.x),PUB[data.m].apply(PUB)):console.error("[mod.xrequest] Invalid XDomainRequest proxy response",data),delete STATIC_PRIVATE.proxies[data.i]},PUB.open=function(method,url,async){PRIV.url=url,PRIV.method=method.toLowerCase(),PRIV.async=async||!0},PUB.send=function(body){var message={i:PRIV.id,m:PRIV.method,u:PRIV.url,b:body||null,t:PUB.timeout,c:PUB.withCredentials};STATIC_PRIVATE.proxyFrame.contentWindow.postMessage(JSON.stringify(message),STATIC_PRIVATE.frameOrigin)},function(){STATIC_PRIVATE.proxies[PRIV.id]=PRIV,PUB.withCredentials=!1,PUB.timeout=0}(),PUB},STATIC_PRIVATE.prepareFetchOptions=function(options,cbName,useLegacyFallback){var opts={method:options.method,timeout:options.timeout||0,setCurrentRequestInstance:options.setCurrentRequestInstance};return"jsonp"===options.dataType&&(opts.cbName=cbName),options.withCredentials&&(opts.credentials=STATIC_PRIVATE.isCrossDomain(options.url)?"include":"same-origin"),options.headers&&"object"==typeof options.headers&&(opts.headers=options.headers),options.redirect&&(opts.redirect=options.redirect),options.hasOwnProperty("contentType")&&("post"===options.method&&(opts.headers=pkg.utils.merge({},opts.headers||{},options.contentType)),delete options.contentType),-1!==["post","put"].indexOf(options.method)?(opts.body=options.data||void 0,"post"===options.method&&"function"==typeof options.onprogress&&(opts.onprogress=options.onprogress)):"get"===options.method&&options.data&&(options.url+=(-1===options.url.indexOf("?")?"?":"&")+options.data,delete options.data),opts.hasNativeTimeoutHandler=useLegacyFallback||options.onprogress,opts},STATIC_PRIVATE.fetchImplementation=function(options,useLegacyFallback){var cbName="_cb"+STATIC_PRIVATE.counter++,fetch="jsonp"===options.dataType?STATIC_PRIVATE.jsonpFetch:useLegacyFallback?STATIC_PRIVATE.legacyFetch:STATIC_PRIVATE.dependencies["mod.fetch"];"post"===options.method&&options.onprogress&&(fetch=STATIC_PRIVATE.xhrUploadFetch);var opts=STATIC_PRIVATE.prepareFetchOptions(options,cbName,useLegacyFallback),url=options.url,context=STATIC_PRIVATE.createContext(options),rejectPromise=!1,executeComplete=function(){try{options.complete.call(context,context.getXHR())}catch(e){console.warning("[mod.xrequest] Exception in complete callback:",e)}};opts.timeout&&(opts.ontimeout=function(){rejectPromise=!0;var err=new Error("Request timeout");if(err.code=408,err.url=url,context._response={status:err.code,statusText:err.message},context._xhr=opts.xhr||STATIC_PRIVATE.createMockXHR(options,context._response,"",null,null),opts.xhr&&"object"==typeof opts.xhr&&opts.xhr.abort&&"function"==typeof opts.xhr.abort)try{opts.xhr.abort()}catch(e){}try{options.ontimeout.call(context,context._xhr,err)}catch(e){console.warning("[mod.xrequest] Exception in timeout callback:",e)}executeComplete()},opts.hasNativeTimeoutHandler||(STATIC_PRIVATE.timeouts[cbName]=window.setTimeout(function(){if(delete STATIC_PRIVATE.timeouts[cbName],"jsonp"===opts.dataType){var scr=document.getElementById(cbName);scr?scr.parentElement.removeChild(scr):console.warning("[mod.xrequest] Unable to locate JSONP script tag in DOM. Cannot remove it even though it timed-out"),STATIC_PRIVATE.callbacks[cbName]=function(){try{delete STATIC_PRIVATE.callbacks[cbName]}catch(e){}}}options.ontimeout=options.origOnTimeout===STATIC_PRIVATE.noop?options.error:options.ontimeout,opts.ontimeout()},opts.timeout)));var errorResponseObject=null;fetch(url,opts).then(function(response){if(rejectPromise)return{status:408,statusText:"timeout"};if(!opts.hasNativeTimeoutHandler)try{window.clearTimeout(STATIC_PRIVATE.timeouts[cbName]),delete STATIC_PRIVATE.timeouts[cbName]}catch(e){}if(context._response=response,response.status>=200&&response.status<300||304===response.status){var respType=response.headers.get("Content-Type"),respMime=STATIC_PRIVATE.parseMime(respType);!options.dataType||respMime===options.dataType||"jsonp"===options.dataType&&"json"===respMime?options.dataType=respMime:(console.warning("[mod.xrequest] Response content type is",respMime,"but we are expecting",options.dataType),console.warning("[mod.xrequest] We will parse the response as",options.dataType,"but beware this can cause trouble!"))}else errorResponseObject=new Error(response.statusText),errorResponseObject.code=response.status,errorResponseObject.url=options.url;return response.text()}).then(function(data){var transformedData=data;if(context._xhr=STATIC_PRIVATE.createMockXHR(options,context._response,data,"xml"===options.dataType?transformedData:null,"json"===options.dataType?transformedData:null),!rejectPromise){if(errorResponseObject){try{options.error.call(context,context._response,errorResponseObject)}catch(ex){console.warning("[mod.xrequest] Exception in error callback:",ex)}return void executeComplete()}if("json"===options.dataType||"jsonp"===options.dataType)try{transformedData=JSON.parse(data||null)}catch(e){e.message="Invalid JSON response: "+e.message;try{options.error.call(context,context._xhr,e)}catch(err){console.warning("[mod.xrequest] Exception in error callback:",err)}return void executeComplete()}if("xml"===options.dataType&&(transformedData=STATIC_PRIVATE.parseXML(data),null===transformedData)){var err=new Error("Invalid XML data");try{options.error.call(context,context._xhr,err)}catch(errr){console.warning("[mod.xrequest] Exception in error callback:",errr)}return void executeComplete()}try{options.success.call(context,transformedData,context._xhr)}catch(e){console.warning("[mod.xrequest] Exception in success callback:",e)}executeComplete()}}).catch(function(e){if(!rejectPromise){console.error("[mod.xrequest]",options.method.toUpperCase(),"request failed:",e),context._response={status:e.code||500,statusText:e.message||"Internal Server Error"},context._xhr=STATIC_PRIVATE.createMockXHR(options,context._response,"",null,null);try{options.error.call(context,context._xhr,e)}catch(ex){console.warning("[mod.xrequest] Exception in error callback:",ex)}executeComplete()}})},STATIC_PRIVATE.xhrUploadFetch=function(url,options){var Promise=STATIC_PRIVATE.dependencies["mod.promise"];return new Promise(function(resolve,reject){var xhr=new XMLHttpRequest;options.setCurrentRequestInstance(xhr),xhr.upload.addEventListener("progress",options.onprogress,!1),xhr.addEventListener("load",function(){4===xhr.readyState&&resolve({status:xhr.status,statusText:xhr.statusText,headers:{get:function(name){return xhr.getResponseHeader(name)}},text:function(){return new Promise(function(resolve,reject){resolve(xhr.responseText)})}})},!1),xhr.addEventListener("error",function(){var e=new Error(xhr.responseText);e.code=xhr.status,e.url=url,reject(e)},!1),xhr.addEventListener("abort",function(){var e=new Error("aborted");e.code=500,e.url=url,reject(e)},!1),xhr.open("POST",url),xhr.send(options.body)})},STATIC_PRIVATE.jsonpFetch=function(url,options){var Promise=STATIC_PRIVATE.dependencies["mod.promise"],cbName=options.cbName;return new Promise(function(resolve,reject){STATIC_PRIVATE.callbacks[cbName]=function(data){delete STATIC_PRIVATE.callbacks[cbName],resolve({status:200,statusText:"OK",headers:{get:function(){return"application/json"}},text:function(){return new Promise(function(resolve,reject){resolve(JSON.stringify(data))})}})};var scr=document.createElement("script");scr.type="text/javascript",scr.src=url+(-1!==url.indexOf("?")?"&":"?")+"callback=_jsonpCallbacks."+options.cbName,scr.id=cbName,document.getElementsByTagName("head")[0].appendChild(scr)})},STATIC_PRIVATE.legacyFetch=function(url,options){var Promise=STATIC_PRIVATE.dependencies["mod.promise"];return new Promise(function(resolve,reject){var hasCustomHeaders=options.headers&&Object.keys(options.headers).length>0,xhr,isFlash=hasCustomHeaders&&"post"===options.method||!!options.credentials,isProxy=STATIC_PRIVATE.isCrossDomain(url,!0),flashOpts={instancePooling:!0,autoUpdatePlayer:!1,xmlResponseText:!1};if(isFlash){console.info("[mod.xrequest] Using Flash fallback");try{xhr=new flensed.flXHR(flashOpts)}catch(e){console.error("[mod.xrequest] Unable to instantiate flXHR helper:",e),reject(e)}}else if(window.XDomainRequest)isProxy?(console.info("[mod.xrequest] Using IFrame Proxy fallback"),xhr=new STATIC_PRIVATE.xhrProxyClass):(console.info("[mod.xrequest] Using XDomainRequest fallback"),xhr=new XDomainRequest,xhr.onprogress=function(){});else{isFlash=!0,console.info("[mod.xrequest] Using Flash fallback since XDomainRequest is not available");try{xhr=new flensed.flXHR(flashOpts)}catch(e){console.error("[mod.xrequest] Unable to instantiate flXHR helper:",e),reject(e)}}if(options.xhr=xhr,xhr.withCredentials=!!options.credentials,options.timeout?(xhr.ontimeout=options.ontimeout,xhr.timeout=options.timeout):isFlash||(xhr.ontimeout=function(){}),isFlash?(xhr.onerror=function(err){var e=new Error(err.description);e.code=err.number,e.url=url,reject(e)},xhr.onreadystatechange=function(xhrObj){4===xhrObj.readyState&&resolve({status:xhrObj.status,statusText:xhrObj.statusText,headers:{get:function(){return""}},text:function(){return new Promise(function(resolve,reject){resolve(xhrObj.responseText)})}})}):(xhr.onerror=function(){var e=new Error(xhr.responseText);e.code=500,e.url=url,reject(e)},xhr.onload=function(){var s=1223===xhr.status?204:xhr.status||200;resolve({status:s,statusText:xhr.statusText||"OK",headers:{get:function(name){return"content-type"===name.toLowerCase()?xhr.contentType:""}},text:function(){return new Promise(function(resolve,reject){resolve(xhr.responseText)})}})}),xhr.open(options.method.toUpperCase(),url,!0),isFlash&&hasCustomHeaders)for(var k in options.headers)options.headers.hasOwnProperty(k)&&xhr.setRequestHeader(k,options.headers[k]);setTimeout(function(){xhr.send(options.body||null)},0)})},STATIC_PUBLIC=function Xrequest(defaults){if(!(this instanceof Xrequest))throw new Error('Xrequest is a constructor. Please, create an instance using the "new" operator". ');var PUBLIC=this,PRIVATE={};PRIVATE.validateOptions=function(options){switch(options.success=options.success||STATIC_PRIVATE.noop,options.error=options.error||STATIC_PRIVATE.noop,options.ontimeout=options.ontimeout||STATIC_PRIVATE.noop,options.complete=options.complete||STATIC_PRIVATE.noop,options.dataType=options.dataType||options.responseType||"text",options.method.toLowerCase()){case"get":if(options.body)return console.error("[mod.xrequest] GET requests cannot have a body"),!1;break;case"post":if("jsonp"===options.dataType)return console.error("[mod.xrequest] JSONP is only valid in GET requests"),!1;if(options.data){if("string"!=typeof options.data&&!options.onprogress)return console.error("[mod.xrequest] POST body MUST be a string!"),!1;var hasContentType=!1;if(options.headers&&"object"==typeof options.headers)for(var k in options.headers)if(options.headers.hasOwnProperty(k)&&"content-type"===k.toLowerCase()){hasContentType=!0;break}hasContentType||(options.contentType={"Content-Type":"application/x-www-form-urlencoded"})}else console.warning("[mod.xrequest] POST request without a body. That's kinda strange...");options.onprogress&&(window.XMLHttpRequestUpload||(console.warning("[mod.xrequest] Browser does not support XMLHttpRequestUpload for using onprogress. Falling back to normal POST"),delete options.onprogress));break;default:if(PRIVATE.isOldIE&&STATIC_PRIVATE.isCrossDomain(options.url))return console.error("[mod.xrequest] Legacy implementations can only work with GET and POST.",options.method.toUpperCase(),"is not supported, so I suggest you get a better Browser!"),!1}return!0},PRIVATE.doRequest=function(method,options){if(!options||"object"!=typeof options||options instanceof Array)throw new Error("options must be an Object");var Promise=STATIC_PRIVATE.dependencies["mod.promise"];return new Promise(function(resolve,reject){Promise.all([STATIC_PRIVATE.flashPromise,STATIC_PRIVATE.iframePromise]).then(function(){var promiseOptions={success:function(data,xhr){resolve(data)},error:function(xhr,e){reject(e)},ontimeout:function(){reject(new Error("timeout"))}},opts=pkg.utils.merge({},promiseOptions,PRIVATE.defaults,options,{method:method,origOnTimeout:options.ontimeout||PRIVATE.defaults.ontimeout,setCurrentRequestInstance:PRIVATE.setCurrentRequestInstance});if(PRIVATE.validateOptions(opts)){var context=STATIC_PRIVATE.createContext(opts),useLegacyFallback="jsonp"!==opts.dataType&&PRIVATE.isOldIE&&STATIC_PRIVATE.isCrossDomain(opts.url);STATIC_PRIVATE.fetchImplementation(opts,useLegacyFallback)}else console.error("[mod.xrequest] Invalid options passed to",opts.method.toUpperCase(),"call:",options),opts.error.call(PUBLIC,null,new Error("Invalid options passed to "+opts.method.toUpperCase()+" call"))})})},PRIVATE.setCurrentRequestInstance=function(instance){PRIVATE.requestInstance=instance},PUBLIC.get=PRIVATE.doRequest.bind(PUBLIC,"get"),PUBLIC.post=PRIVATE.doRequest.bind(PUBLIC,"post"),PUBLIC.head=PRIVATE.doRequest.bind(PUBLIC,"head"),PUBLIC.put=PRIVATE.doRequest.bind(PUBLIC,"put"),PUBLIC.delete=PRIVATE.doRequest.bind(PUBLIC,"delete"),PUBLIC.patch=PRIVATE.doRequest.bind(PUBLIC,"patch"),PUBLIC.abortCurrentRequest=function(){PRIVATE.requestInstance&&PRIVATE.requestInstance.abort&&PRIVATE.requestInstance.abort(),PRIVATE.setCurrentRequestInstance(null)},function(){if(PRIVATE.isOldIE=STATIC_PUBLIC.isLegacyBrowser(),PRIVATE.defaults=defaults||{},!(PRIVATE.defaults instanceof Object)||PRIVATE.defaults instanceof Array)throw new Error("Default settings must be an object");if(PRIVATE.method&&delete PRIVATE.method,PRIVATE.isOldIE&&!PRIVATE.defaults.isProxy){var temp;PRIVATE.defaults.assetsPath?temp=PRIVATE.defaults.assetsPath:(temp=document.querySelector('script[src*="zaz-mod-xrequest/_js"]'),temp&&(temp=temp.getAttribute("src").replace(/(_js\/)?(zaz-)?mod-xrequest[^/]*$/,"").replace(/\/$/,"")+"/assets"),temp||(temp=document.querySelector('script[src*="scripts/zaz."]').getAttribute("src").replace(/\/fe\/.*$/,"/fe/zaz-mod-xrequest/assets"))),PRIVATE.basePathToAssets=temp,STATIC_PRIVATE.injectProxyFrame(PRIVATE.basePathToAssets),STATIC_PRIVATE.injectFlashObject(PRIVATE.basePathToAssets)}else STATIC_PRIVATE.resolveFlashPromise(),STATIC_PRIVATE.resolveIFramePromise()}()},STATIC_PUBLIC.isLegacyBrowser=function(){return/MSIE [6-9]/i.test(navigator.userAgent)},STATIC_PUBLIC.serialize=function(paramsArray){return Object.keys(paramsArray).map(function(v){return v+"="+this[v]},paramsArray).join("&")},STATIC_PUBLIC},teardown:function(reason){}})});